<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <title>Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="{{ url_for('static', filename='js/highlight.js') }}"></script>
</head>

<body>

  <div class="container">
    <h1>PDF検索エンジン</h1>

    <h3 class="mt-3">情報源</h3>
    <div id="sources">
    </div>

    <form>
      <div class="form-group mt-3">
        <label for="search">キーワード</label>
        <input type="text" class="form-control" id="search" placeholder="キーワード入力（コンマ区切り）">
      </div>

      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="tf-idf" checked>
        <label class="form-check-label" for="tf-idf">TF-IDF</label>
      </div>
  
      <input type="button" class="btn btn-primary" onclick="searchPDF()" value="Submit"></input>
    </form>

    <table id="search_result_table" class="table table-bordered mt-3">
    </table>
  </div>

  <script>
    var sources;

    const API_BASE_URL = 'http://127.0.0.1:5000';
    (async () => {
      const response = await fetch(API_BASE_URL + '/sources');
      sources = await response.json();
      const sourcesDiv = document.getElementById('sources');
      sources.forEach(source => {
        const div = document.createElement('div');
        div.setAttribute('class', 'form-check');
        div.innerHTML = `\
        <input class="form-check-input" type="checkbox" value="${source.base_url}" id="${source.base_url}" checked>\
        <label class="form-check-label" for="${source.base_url}">\
          <a href=${source.homepage_url}>${source.org}</a>: <a href=${source.doc_url}>${source.doc}</a>\
        </label>\
        `;
        sourcesDiv.append(div);
      })
    })();
  </script>

  <script>
    const searchResultTable = document.getElementById('search_result_table');

    const search = (sources) => {
      const keywords = document.getElementById('search').value;
      const tf_idf = document.getElementById('tf-idf').checked;

      searchResultTable.innerHTML = '';

      sources.forEach(source => {
        const checkbox = document.getElementById(source.base_url);
        if (checkbox.checked) {
          search_(source, keywords, tf_idf);
        }
      });
    }

    const search_ = async (source, keywords, tf_idf) => {

      if (keywords.trim() == '') return;

      var tf_idf_ = "true";
      if (tf_idf === false) {
        tf_idf_ = "false"
      }

      const path = encodeURI(`/search?base_url=${source.base_url}&keywords=${keywords}&tf-idf=${tf_idf_}`);
      const response = await fetch(API_BASE_URL + path);
      const searchResult = await response.json();
      //console.log(`getSearchResult: ${JSON.stringify(searchResult)}`);

      const tr = document.createElement('tr')

      const columns = ['doc', 'title', 'page', 'text'];
      columns.forEach(e => {
        const th = document.createElement('th');
        th.innerText = e;
        tr.append(th);
      });
      const thead = document.createElement('thead');
      thead.setAttribute('class', 'thead-dark');
      thead.append(tr);
      searchResultTable.append(thead);

      const tbody = document.createElement('tbody');
      searchResult.forEach(e => {
        const tr = document.createElement('tr');
        columns.forEach(c => {
          var td = document.createElement('td');
          switch (c) {
            case 'text':
              const spans = []
              for (key in e.spans) {
                spans.push(...e.spans[key])
              }
              //console.log(spans);
              td.innerHTML = `<div>...${highlightText(e[c], spans)}...</div>`;
              break;
            case 'title':
              const url_title = encodeURI(`/highlight?link_id=${e.link_id}&page=${e.page}&keywords=${keywords}&all_pages=true`)
              td.innerHTML = `<a href="${url_title}#page=${e.page + 1}">${e.title}</a>`
              break;
            case 'page':
              const url_page = encodeURI(`/highlight?link_id=${e.link_id}&page=${e.page}&keywords=${keywords}`)
              td.innerHTML = `<a href="${url_page}#page=2">${e.page}</a>`
              break;
            case 'doc':
              td.innerHTML = `<a href="${source.doc_url}">${source.doc}</a>`
              break;
            default:
              td.innerText = e[c];
              break;
          }
          tr.append(td);
        });
        tbody.append(tr);
      })
      searchResultTable.append(tbody);
    }

    const searchPDF = () => {
      search(sources);
    }

    document.getElementById('search').addEventListener("keypress", event => {
      if (event.key === "Enter") {
        event.preventDefault();
        searchPDF();
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
</body>

</html>